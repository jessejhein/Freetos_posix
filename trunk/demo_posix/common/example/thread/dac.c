/************************************************************************************************
 * File: 			app_dac.c
 * Description:		dac task employing posix thread and file API
 ***********************************************************************************************
 * SUMMARY:         Generate sine wave of 2Hz 
 ***********************************************************************************************/

#include <define.h>
#include <unistd.h>
#include <sys/ioctl.h>

#ifndef I2C_DAC_MOD
#error "I2C_DAC_MOD has been disabled."
#endif

const unsigned int sine[] = { 511, 575, 638, 699, 757, 811, 861, 905, 942, 973,
                                997,1013,1021,1021,1013, 997, 973, 942, 905, 861,
                                811, 757, 699, 638, 575, 511, 447, 384, 323, 265,
                                211, 161, 117,  80,  49,  25,   9,   1,   1,   9,
                                 25,  49,  80, 117, 161, 211, 265, 323, 384, 447};

/************************************************************************************************
 * Global Variables
 ***********************************************************************************************/
extern int fd_dac;				//file descriptor for i2c

/************************************************************************************************
 * tskDAC()
 ***********************************************************************************************/
void* tskDAC(void *ptr)
{
	static unsigned char ch = DAC_PRIMARY;
	ioctl(fd_dac, DAC_SET_CTL, &ch);
    static int i=0;

	//=======================================================================
	start_process();
    //=======================================================================
    
    while(1){
        for(i=0; i<50; i++){
            while(write(fd_dac, (unsigned int*)(sine + i), sizeof(unsigned int)) != sizeof(unsigned int));
            usleep(10000);      //Update every 10ms
        }
    }

    //=======================================================================
	end_process();
    //=======================================================================
}
